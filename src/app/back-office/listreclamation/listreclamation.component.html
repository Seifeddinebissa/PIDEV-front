<div class="reclamation-container">
  <!-- Background banner (optional) -->
  <div class="dashboard__top-bg" data-background="assets/img/bg/student_bg.jpg" style="background-image: url('assets/img/bg/student_bg.jpg');"></div>

  <h2 class="title">Complaint Management</h2>

  <!-- Navigation and export buttons -->
  <div class="navigation-buttons">
    <button class="nav-btn" [class.active]="currentView === 'list'" (click)="showList()">View Complaints</button>
    <button class="nav-btn" [class.active]="currentView === 'add'" (click)="showAddForm()">Add Complaint</button>
    <button class="nav-btn export-btn" (click)="exportToPDF()">Export to PDF</button>
    <button class="nav-btn export-btn" (click)="exportToExcel()">Export to Excel</button>
    
    <button class="nav-btn" (click)="stopSpeech()" *ngIf="isSpeaking">Stop Reading</button>
  </div>
  <!-- View: Complaints list in table format -->
  <div *ngIf="currentView === 'list'">
    <!-- Statistics by status -->
    <div class="stats-spacer"></div> <!-- Spacing between buttons and statistics -->
    <div class="stats-section">
      <h3>Complaint Statistics</h3>
      <div class="stats-container">
        <div class="stat-item">
          <span class="stat-label">Pending</span>
          <span class="stat-value">{{ statsByStatus.enAttente }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">In Progress</span>
          <span class="stat-value">{{ statsByStatus.enCours }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Resolved</span>
          <span class="stat-value">{{ statsByStatus.resolu }}</span>
        </div>
        <div class="stat-item total">
          <span class="stat-label">Total</span>
          <span class="stat-value">{{ statsByStatus.total }}</span>
        </div>
      </div>
    </div>
    <div *ngIf="!statsByStatus || statsByStatus.total === 0" class="stats-section">
      <p>No statistics available at the moment.</p>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="search-form">
        <div class="select-container">
          <span class="select-icon">ðŸ“‹</span>
          <select class="custom-select" [(ngModel)]="filterStatus" (change)="selectStatus(filterStatus)" aria-label="Filter by status">
            <option value="" selected>All</option>
            <option value="En attente">Pending</option>
            <option value="En cours">In Progress</option>
            <option value="RÃ©solu">Resolved</option>
          </select>
        </div>
        <div class="search-container">
          <input type="text" id="searchTerm" [(ngModel)]="searchTerm" name="searchTerm" placeholder="Search by subject..." (input)="onSearchInput($event)">
          <button type="button" class="search-button" (click)="applyFilters()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19.7071 18.2929L15.0455 13.6313C16.3978 12.001 17.1929 9.82088 17.1929 7.5C17.1929 3.35786 13.835 0 9.69286 0C5.55072 0 2.19286 3.35786 2.19286 7.5C2.19286 11.6421 5.55072 15 9.69286 15C12.013 15 14.1931 14.2049 15.8234 12.8525L20.485 17.5141C20.7782 17.8073 20.7782 18.2797 20.485 18.5729C20.1918 18.8661 19.7194 18.8661 19.4262 18.5729L19.7071 18.2929ZM9.69286 14C6.21107 14 3.19286 10.9818 3.19286 7.5C3.19286 4.01821 6.21107 1 9.69286 1C13.1746 1 16.1929 4.01821 16.1929 7.5C16.1929 10.9818 13.1746 14 9.69286 14Z" fill="#6a5acd" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Complaints table -->
    <div class="dashboard__review-table">
      <table class="table table-borderless">
        <thead>
          <tr>
            <th (click)="sort('dateSubmitted')">
              Date
              <span *ngIf="sortField === 'dateSubmitted'">
                {{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}
              </span>
            </th>
            <th (click)="sort('subject')">
              Subject
              <span *ngIf="sortField === 'subject'">
                {{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}
              </span>
            </th>
            <th (click)="sort('description')">
              Description
              <span *ngIf="sortField === 'description'">
                {{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}
              </span>
            </th>
            <th (click)="sort('status')">
              Status
              <span *ngIf="sortField === 'status'">
                {{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}
              </span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="!reclamations || reclamations.length === 0">
            <td colspan="5">No complaints found</td>
          </tr>
          <tr *ngFor="let reclamation of reclamations">
            <td>{{ reclamation.dateSubmitted | date: 'dd MMMM, yyyy' }}</td>
            <td>{{ reclamation.subject }}</td>
            <td>{{ reclamation.description }}</td>
            <td>
              <span class="status" [ngClass]="{
                'pending': reclamation.status === 'En attente',
                'in-progress': reclamation.status === 'En cours',
                'resolved': reclamation.status === 'RÃ©solu'
              }">
                {{ reclamation.status === 'En attente' ? 'Pending' : 
                   reclamation.status === 'En cours' ? 'In Progress' : 
                   reclamation.status === 'RÃ©solu' ? 'Resolved' : reclamation.status }}
              </span>
            </td>
            <td>
              <div class="dashboard__review-action">
                <a href="#" title="Edit" (click)="editReclamation(reclamation); $event.preventDefault()">
                  <i class="skillgro-edit"></i>
                </a>
                <a href="#" title="Delete" *ngIf="reclamation.id" (click)="deleteReclamation(reclamation.id); $event.preventDefault()">
                  <i class="skillgro-bin"></i>
                </a>
                <a href="#" title="Read" (click)="readReclamation(reclamation); $event.preventDefault()" [class.disabled]="isSpeaking">
                  <i class="skillgro-volume"></i> <!-- IcÃ´ne pour "Lire" -->
                </a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav class="pagination__wrap">
      <ul class="list-wrap">
        <li *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="i === currentPage">
          <a href="#" (click)="goToPage(i); $event.preventDefault()">{{ i + 1 }}</a>
        </li>
      </ul>
    </nav>

    <!-- Update form -->
    <div *ngIf="currentView === 'list' && selectedReclamation" class="form-container">
      <h2 class="form-title">Edit Complaint</h2>
      <form (ngSubmit)="updateReclamation()">
        <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
        <div class="form-group">
          <label for="editSubject">Subject</label>
          <input type="text" id="editSubject" [(ngModel)]="selectedReclamation.subject" name="editSubject" placeholder="Subject" required />
        </div>
        <div class="form-group">
          <label for="editDescription">Description</label>
          <textarea id="editDescription" [(ngModel)]="selectedReclamation.description" name="editDescription" placeholder="Description" required></textarea>
        </div>
        <div class="form-group">
          <label for="editStatus">Status</label>
          <select id="editStatus" [(ngModel)]="selectedReclamation.status" name="editStatus" required>
            <option value="En attente">Pending</option>
            <option value="En cours">In Progress</option>
            <option value="RÃ©solu">Resolved</option>
          </select>
        </div>
        <button type="submit" class="submit-btn">Update</button>
      </form>
    </div>
  </div>

  <!-- View: Add form -->
  <div *ngIf="currentView === 'add'" class="form-container">
    <h2 class="form-title">Add Complaint</h2>
    <form (ngSubmit)="addReclamation()">
      <div class="error-message" *ngIf="errorMessage">{{ errorMessage }}</div>
      <div class="form-group">
        <label for="subject">Subject</label>
        <input type="text" id="subject" [(ngModel)]="newReclamation.subject" name="subject" placeholder="Subject" required />
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" [(ngModel)]="newReclamation.description" name="description" placeholder="Description" required></textarea>
      </div>
      <div class="form-group">
        <label for="status">Status</label>
        <select id="status" [(ngModel)]="newReclamation.status" name="status" required>
          <option value="En attente">Pending</option>
          <option value="En cours">In Progress</option>
          <option value="RÃ©solu">Resolved</option>
        </select>
      </div>
      <button type="submit" class="submit-btn">Add</button>
    </form>
  </div>
</div>